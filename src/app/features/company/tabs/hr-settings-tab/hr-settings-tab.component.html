<!-- Help Popover -->
<p-popover #helpPopover>
  <ng-template pTemplate="content">
    <div class="w-80 p-3">
      <div class="flex items-start gap-3 mb-4">
        <div class="shrink-0 size-9 bg-blue-100 rounded-lg flex items-center justify-center">
          <i class="pi pi-info-circle text-blue-600 text-lg"></i>
        </div>
        <div>
          <h3 class="text-sm font-semibold text-gray-900 mb-1">
            {{ 'company.hrSettings.helpTitle' | translate }}
          </h3>
          <p class="text-xs text-gray-600 leading-relaxed">
            {{ 'company.hrSettings.helpDescription' | translate }}
          </p>
        </div>
      </div>
      
      <ul class="space-y-2.5 pt-3 border-t border-gray-100">
        @for (point of helpPoints; track point) {
          <li class="flex items-start gap-2">
            <i class="pi pi-check-circle text-blue-600 text-xs mt-0.5 shrink-0"></i>
            <span class="text-xs text-gray-700">{{ point | translate }}</span>
          </li>
        }
      </ul>
    </div>
  </ng-template>
</p-popover>

<!-- Loading Skeleton -->
@if (loading() && !company()) {
  <div class="animate-pulse p-6">
    <div class="space-y-6 max-w-4xl mx-auto">
      @for (i of [1, 2, 3]; track i) {
        <div class="bg-gray-200 rounded-xl h-48"></div>
      }
    </div>
  </div>
}

<!-- Main Content -->
@if (!loading() || company()) {
  <div class="p-4 sm:p-6">
    <div class="max-w-4xl mx-auto">
      
      <!-- Page Header -->
      <header class="flex items-center justify-between mb-6">
        <div>
          <h1 class="text-xl font-semibold text-gray-900">
            {{ 'company.hrSettings.title' | translate }}
          </h1>
          <p class="text-sm text-gray-500 mt-1">
            {{ 'company.hrSettings.helpDescription' | translate }}
          </p>
        </div>
        <button 
          type="button"
          (click)="helpPopover.toggle($event)"
          class="shrink-0 size-10 rounded-full bg-blue-50 hover:bg-blue-100 border border-blue-200 grid place-items-center transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
          [attr.aria-label]="'company.hrSettings.helpTitle' | translate"
          aria-haspopup="dialog">
          <i class="pi pi-question-circle text-blue-600 text-lg"></i>
        </button>
      </header>

      <!-- Form Error Summary -->
      @if (formSubmitted && hrForm.invalid) {
        <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg" role="alert" aria-live="polite">
          <div class="flex items-start gap-3">
            <i class="pi pi-exclamation-triangle text-red-600 mt-0.5"></i>
            <div>
              <h2 class="text-sm font-semibold text-red-900 mb-1">
                {{ 'company.hrSettings.formErrors' | translate }}
              </h2>
              <ul class="text-sm text-red-800 space-y-1 list-disc list-inside">
                @if (hrForm.get('workingDays')?.invalid) {
                  <li>{{ 'company.hrSettings.errors.workingDaysRequired' | translate }}</li>
                }
                @if (hrForm.get('standardHoursPerDay')?.invalid) {
                  <li>{{ 'company.hrSettings.errors.hoursInvalid' | translate }}</li>
                }
                @if (hrForm.get('currency')?.invalid) {
                  <li>{{ 'company.hrSettings.errors.currencyRequired' | translate }}</li>
                }
                @if (hrForm.get('paymentFrequency')?.invalid) {
                  <li>{{ 'company.hrSettings.errors.paymentFrequencyRequired' | translate }}</li>
                }
                @if (hrForm.get('fiscalYearStartMonth')?.invalid) {
                  <li>{{ 'company.hrSettings.errors.fiscalYearRequired' | translate }}</li>
                }
              </ul>
            </div>
          </div>
        </div>
      }

      <!-- Form -->
      <form [formGroup]="hrForm" (ngSubmit)="onSubmit()" class="space-y-6">
        
        <!-- Working Schedule Section -->
        <section class="bg-white rounded-xl border border-gray-200 shadow-sm" aria-labelledby="schedule-heading">
          <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <h2 id="schedule-heading" class="text-lg font-semibold text-gray-900 flex items-center gap-2">
              <i class="pi pi-calendar text-blue-600"></i>
              {{ 'company.hrSettings.workingSchedule' | translate }}
            </h2>
            <p class="text-sm text-gray-600 mt-1">
              {{ 'company.hrSettings.workingScheduleDesc' | translate }}
            </p>
          </div>
          
          <div class="p-6 space-y-6">
            <!-- Working Days -->
            <div class="form-field">
              <label for="workingDays" class="form-label form-label-required">
                {{ 'company.hrSettings.workingDays' | translate }}
              </label>
              
              <!-- Days Selector with Enhanced UI -->
              <div class="grid grid-cols-7 gap-2">
                @for (day of workingDaysOptions; track day.value) {
                  <button
                    type="button"
                    [class]="'relative flex flex-col items-center justify-center p-2 rounded-lg border-2 transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 ' + 
                      (hrForm.get('workingDays')?.value?.includes(day.value) 
                        ? (day.isWeekend ? 'bg-amber-50 border-amber-400 text-amber-700' : 'bg-blue-50 border-blue-500 text-blue-700')
                        : 'bg-white border-gray-200 text-gray-500 hover:border-gray-300 hover:bg-gray-50')"
                    (click)="toggleWorkingDay(day.value)"
                    [attr.aria-label]="day.fullName"
                    [attr.aria-pressed]="hrForm.get('workingDays')?.value?.includes(day.value)">
                    
                    <!-- Selection Indicator -->
                    @if (hrForm.get('workingDays')?.value?.includes(day.value)) {
                      <div class="absolute -top-1 -right-1 size-4 rounded-full flex items-center justify-center"
                           [class]="day.isWeekend ? 'bg-amber-500' : 'bg-blue-600'">
                        <i class="pi pi-check text-white text-[10px]"></i>
                      </div>
                    }
                    
                    <!-- Day Icon -->
                    <i [class]="'pi text-base mb-1 ' + day.icon"></i>
                    
                    <!-- Day Label -->
                    <span class="text-[11px] font-semibold tracking-wide">{{ day.label }}</span>
                    
                    <!-- Tooltip on hover -->
                    <span class="absolute -bottom-8 left-1/2 -translate-x-1/2 opacity-0 hover:opacity-100 transition-opacity bg-gray-900 text-white text-xs px-2 py-1 rounded whitespace-nowrap pointer-events-none">
                      {{ day.fullName }}
                    </span>
                  </button>
                }
              </div>
              
              <small id="workingDays-help" class="mt-3 text-xs text-gray-500 flex items-start gap-1.5">
                <i class="pi pi-info-circle text-blue-500 mt-0.5 shrink-0"></i>
                <span>{{ 'company.hrSettings.workingDaysHint' | translate }}</span>
              </small>
              
              @if (isFieldInvalid('workingDays')) {
                <small class="form-error flex items-center gap-1.5" role="alert">
                  <i class="pi pi-exclamation-circle"></i>
                  <span>{{ 'company.hrSettings.errors.workingDaysRequired' | translate }}</span>
                </small>
              }
            </div>

            <!-- Standard Hours -->
            <div class="form-field">
              <label class="form-label form-label-required">
                {{ 'company.hrSettings.standardHoursPerDay' | translate }}
              </label>
              
              <!-- Quick Preset Hours + Custom Input -->
              <div class="flex items-center gap-3">
                <!-- Preset Buttons -->
                <div class="flex gap-1.5">
                  @for (preset of hoursPresets; track preset) {
                    <button
                      type="button"
                      [class]="'relative flex items-center justify-center size-10 rounded-lg border transition-colors duration-150 text-sm font-semibold ' +
                        (hrForm.get('standardHoursPerDay')?.value === preset
                          ? 'bg-blue-600 border-blue-600 text-white'
                          : 'bg-white border-gray-300 text-gray-700 hover:border-blue-400 hover:bg-blue-50')"
                      (click)="setStandardHours(preset)"
                      [attr.aria-label]="preset + ' hours'"
                      [attr.aria-pressed]="hrForm.get('standardHoursPerDay')?.value === preset">
                      {{ preset }}h
                    </button>
                  }
                </div>
                
                <!-- Divider -->
                <div class="h-8 w-px bg-gray-300"></div>
                
                <!-- Custom Input -->
                <div class="flex-1 max-w-[180px]">
                  <p-inputNumber
                    id="standardHoursPerDay"
                    formControlName="standardHoursPerDay"
                    [min]="0"
                    [max]="24"
                    [minFractionDigits]="1"
                    [maxFractionDigits]="1"
                    suffix=" hrs"
                    styleClass="w-full"
                    [attr.aria-required]="true"
                    [attr.aria-invalid]="isFieldInvalid('standardHoursPerDay')"
                    aria-describedby="hours-help">
                  </p-inputNumber>
                </div>
              </div>
              
              <small id="hours-help" class="block mt-2 text-xs text-gray-500">
                {{ 'company.hrSettings.standardHoursHint' | translate }}
              </small>
              
              @if (isFieldInvalid('standardHoursPerDay')) {
                <small class="form-error flex items-center gap-1" role="alert">
                  <i class="pi pi-exclamation-circle"></i>
                  {{ 'company.hrSettings.errors.hoursInvalid' | translate }}
                </small>
              }
            </div>
          </div>
        </section>

        <!-- Leave Rules Section -->
        <section class="bg-white rounded-xl border border-gray-200 shadow-sm" aria-labelledby="leave-heading">
          <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <h2 id="leave-heading" class="text-lg font-semibold text-gray-900 flex items-center gap-2">
              <i class="pi pi-sun text-amber-600"></i>
              {{ 'company.hrSettings.leaveRules' | translate }}
            </h2>
            <p class="text-sm text-gray-600 mt-1">
              {{ 'company.hrSettings.leaveRulesDesc' | translate }}
            </p>
          </div>
          
          <div class="p-6 form-grid">
            <!-- Leave Rate -->
            <div class="form-field">
              <label for="leaveRate" class="form-label form-label-required">
                {{ 'company.hrSettings.leaveRate' | translate }}
              </label>
              <p-select 
                id="leaveRate"
                [options]="leaveRateOptions" 
                formControlName="leaveAccrualRate" 
                optionLabel="label" 
                optionValue="value"
                styleClass="w-full"
                [attr.aria-required]="true"
                aria-describedby="leaveRate-help">
              </p-select>
              <small id="leaveRate-help" class="block mt-2 text-xs text-gray-500">
                {{ 'company.hrSettings.leaveRateHint' | translate }}
              </small>
            </div>

            <!-- Include Saturdays -->
            <div class="form-field">
              <span class="form-label form-label-required">
                {{ 'company.hrSettings.includeSaturdays' | translate }}
              </span>
              <div class="flex items-center gap-6" role="radiogroup">
                <div class="flex items-center gap-2">
                  <p-radioButton 
                    name="includeSaturdays" 
                    [value]="true" 
                    formControlName="includeSaturdays" 
                    inputId="satYes">
                  </p-radioButton>
                  <label for="satYes" class="text-sm text-gray-700 cursor-pointer">
                    {{ 'common.yes' | translate }}
                  </label>
                </div>
                <div class="flex items-center gap-2">
                  <p-radioButton 
                    name="includeSaturdays" 
                    [value]="false" 
                    formControlName="includeSaturdays" 
                    inputId="satNo">
                  </p-radioButton>
                  <label for="satNo" class="text-sm text-gray-700 cursor-pointer">
                    {{ 'common.no' | translate }}
                  </label>
                </div>
              </div>
              <small class="block mt-2 text-xs text-gray-500">
                {{ 'company.hrSettings.saturdaysHint' | translate }}
              </small>
            </div>
          </div>
        </section>

        <!-- Paramétrage Paie Section -->
        <section class="bg-white rounded-xl border border-gray-200 shadow-sm" aria-labelledby="payroll-heading">
          <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <h2 id="payroll-heading" class="text-lg font-semibold text-gray-900 flex items-center gap-2">
              <i class="pi pi-wallet text-amber-600"></i>
              {{ 'company.hrSettings.payrollSetup' | translate }}
            </h2>
          </div>
          
          <div class="p-6 form-grid">
            <!-- Currency -->
            <div class="form-field">
              <label for="currency" class="form-label form-label-required">
                {{ 'company.hrSettings.currency' | translate }}
              </label>
              <p-select 
                id="currency"
                [options]="currencyOptions" 
                formControlName="currency" 
                optionLabel="label" 
                optionValue="value"
                styleClass="w-full"
                [attr.aria-required]="true">
                <ng-template let-option pTemplate="item">
                  {{ option.label | translate }}
                </ng-template>
                <ng-template let-option pTemplate="selectedItem">
                  {{ option.label | translate }}
                </ng-template>
              </p-select>
            </div>

            <!-- Payment Frequency -->
            <div class="form-field">
              <label for="paymentFrequency" class="form-label form-label-required">
                {{ 'company.hrSettings.paymentFrequency' | translate }}
              </label>
              <p-select 
                id="paymentFrequency"
                [options]="paymentFrequencyOptions" 
                formControlName="paymentFrequency" 
                optionLabel="label" 
                optionValue="value"
                styleClass="w-full"
                [attr.aria-required]="true">
                <ng-template let-option pTemplate="item">
                  {{ option.label | translate }}
                </ng-template>
                <ng-template let-option pTemplate="selectedItem">
                  {{ option.label | translate }}
                </ng-template>
              </p-select>
            </div>

            <!-- Fiscal Year Start Month -->
            <div class="form-field">
              <label for="fiscalMonth" class="form-label form-label-required">
                {{ 'company.hrSettings.fiscalYearStartMonth' | translate }}
              </label>
              <p-select 
                id="fiscalMonth"
                [options]="fiscalMonthOptions" 
                formControlName="fiscalYearStartMonth" 
                optionLabel="label" 
                optionValue="value"
                styleClass="w-full"
                [attr.aria-required]="true">
                <ng-template let-option pTemplate="item">
                  {{ option.label | translate }}
                </ng-template>
                <ng-template let-option pTemplate="selectedItem">
                  {{ option.label | translate }}
                </ng-template>
              </p-select>
            </div>

            <!-- Payment Mode -->
            <div class="form-field">
              <label for="paymentMode" class="form-label">
                {{ 'company.hrSettings.paymentModeEmployees' | translate }}
                <span class="text-gray-400 text-xs font-normal ml-1">({{ 'common.optional' | translate }})</span>
              </label>
              <p-select 
                id="paymentMode"
                [options]="paymentModeOptions" 
                formControlName="defaultPaymentMode" 
                optionLabel="label" 
                optionValue="value"
                [placeholder]="'company.hrSettings.selectPaymentMode' | translate"
                styleClass="w-full">
                <ng-template let-option pTemplate="item">
                  {{ option.label | translate }}
                </ng-template>
                <ng-template let-option pTemplate="selectedItem">
                  {{ option.label | translate }}
                </ng-template>
              </p-select>
            </div>
          </div>
        </section>

        <!-- Paramètres Avancés Section -->
        <section class="bg-white rounded-xl border border-gray-200 shadow-sm" aria-labelledby="advanced-heading">
          <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <h2 id="advanced-heading" class="text-lg font-semibold text-gray-900 flex items-center gap-2">
              <i class="pi pi-cog text-gray-600"></i>
              {{ 'company.hrSettings.advancedSettings' | translate }}
            </h2>
          </div>
          
          <div class="p-6 form-container">
            <!-- Sector / Activity -->
            <div class="form-field">
              <label for="sector" class="form-label">
                {{ 'company.hrSettings.sector' | translate }}
              </label>
              <p-select 
                id="sector"
                [options]="sectorOptions" 
                formControlName="sector" 
                optionLabel="label" 
                optionValue="value"
                [placeholder]="'company.hrSettings.selectSector' | translate"
                styleClass="w-full">
                <ng-template let-option pTemplate="item">
                  {{ option.label | translate }}
                </ng-template>
                <ng-template let-option pTemplate="selectedItem">
                  {{ option.label | translate }}
                </ng-template>
              </p-select>
            </div>

            <!-- Collective Agreement -->
            <div class="form-field">
              <label for="collectiveAgreement" class="form-label">
                {{ 'company.hrSettings.collectiveAgreement' | translate }}
                <span class="text-gray-400 text-xs font-normal ml-1">({{ 'company.hrSettings.collectiveAgreementHint' | translate }})</span>
              </label>
              <input 
                pInputText 
                id="collectiveAgreement" 
                formControlName="collectiveAgreement" 
                class="input"
                [placeholder]="'company.hrSettings.collectiveAgreementPlaceholder' | translate"
                maxlength="200" />
            </div>

            <!-- CNSS Specific Parameters -->
            <div class="form-field">
              <label for="cnssParams" class="form-label">
                {{ 'company.hrSettings.cnssSpecificParams' | translate }}
                <span class="text-gray-400 text-xs font-normal ml-1">({{ 'company.hrSettings.cnssSpecificParamsHint' | translate }})</span>
              </label>
              <textarea 
                pTextarea 
                id="cnssParams" 
                formControlName="cnssSpecificParameters" 
                class="input"
                [placeholder]="'company.hrSettings.cnssSpecificParamsPlaceholder' | translate"
                rows="3"
                maxlength="500">
              </textarea>
            </div>

            <!-- IR Specific Parameters -->
            <div class="form-field">
              <label for="irParams" class="form-label">
                {{ 'company.hrSettings.irSpecificParams' | translate }}
                <span class="text-gray-400 text-xs font-normal ml-1">({{ 'company.hrSettings.irSpecificParamsHint' | translate }})</span>
              </label>
              <textarea 
                pTextarea 
                id="irParams" 
                formControlName="irSpecificParameters" 
                class="input"
                [placeholder]="'company.hrSettings.irSpecificParamsPlaceholder' | translate"
                rows="3"
                maxlength="500">
              </textarea>
            </div>
          </div>
        </section>

        <!-- Form Actions -->
        <footer class="form-actions justify-between">
          <p class="text-sm text-gray-500 flex items-center gap-1">
            <i class="pi pi-info-circle"></i>
            {{ 'company.hrSettings.saveNote' | translate }}
          </p>
          <div class="flex gap-3">
            <p-button 
              type="button"
              severity="secondary"
              [label]="'common.cancel' | translate" 
              icon="pi pi-times"
              [disabled]="loading()"
              (onClick)="onCancel()">
            </p-button>
            <p-button 
              type="submit" 
              [label]="'common.save' | translate" 
              [loading]="loading()" 
              [disabled]="loading()"
              icon="pi pi-check">
            </p-button>
          </div>
        </footer>
      </form>
    </div>
  </div>
}

<p-toast />
