<div class="p-6">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
    <div>
      <div class="flex items-center gap-3">
        <h1 class="text-2xl font-bold text-gray-900">Cabinet Portfolio</h1>
        <p-tag value="Owner" severity="info" [rounded]="true"></p-tag>
      </div>
      <p class="text-gray-500 mt-1">Manage all your client companies in one place</p>
    </div>
    
    <!-- Error Banner -->
    <div *ngIf="error()" class="w-full md:w-auto">
      <p-message severity="error" [text]="error() || ''"></p-message>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="card flex items-center p-4 shadow-sm border border-gray-200 rounded-lg bg-white">
      <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 mr-4">
        <i class="pi pi-building text-xl"></i>
      </div>
      <div>
        <span class="block text-gray-500 text-sm font-medium">Total Sociétés</span>
        <span class="block text-2xl font-bold text-gray-900">
          <p-skeleton *ngIf="isLoading()" width="2rem" height="2rem"></p-skeleton>
          <span *ngIf="!isLoading()">{{ totalCompanies() }}</span>
        </span>
      </div>
    </div>
    
    <div class="card flex items-center p-4 shadow-sm border border-gray-200 rounded-lg bg-white">
      <div class="w-12 h-12 rounded-full bg-green-50 flex items-center justify-center text-green-600 mr-4">
        <i class="pi pi-check-circle text-xl"></i>
      </div>
      <div>
        <span class="block text-gray-500 text-sm font-medium">Active Sociétés</span>
        <span class="block text-2xl font-bold text-gray-900">
          <p-skeleton *ngIf="isLoading()" width="2rem" height="2rem"></p-skeleton>
          <span *ngIf="!isLoading()">{{ activeCompanies() }}</span>
        </span>
      </div>
    </div>
    
    <div class="card flex items-center p-4 shadow-sm border border-gray-200 rounded-lg bg-white">
      <div class="w-12 h-12 rounded-full bg-amber-50 flex items-center justify-center text-amber-600 mr-4">
        <i class="pi pi-exclamation-triangle text-xl"></i>
      </div>
      <div>
        <span class="block text-gray-500 text-sm font-medium">Sync Issues</span>
        <span class="block text-2xl font-bold text-gray-900">
          <p-skeleton *ngIf="isLoading()" width="2rem" height="2rem"></p-skeleton>
          <span *ngIf="!isLoading()">{{ syncIssues() }}</span>
        </span>
      </div>
    </div>
  </div>

  <!-- Portfolio Table -->
  <div class="card bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
    <p-table 
      #dt
      [value]="companies()" 
      [loading]="isLoading()"
      [paginator]="true" 
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50]"
      [globalFilterFields]="['legalName', 'ice', 'status']"
      selectionMode="single"
      styleClass="p-datatable-sm"
      [rowHover]="true">
      
      <ng-template pTemplate="caption">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 p-2">
          <div class="flex items-center gap-2">
            <button pButton label="Clear" class="p-button-outlined p-button-sm" icon="pi pi-filter-slash" (click)="clearFilters(dt)"></button>
          </div>
          <p-iconField iconPosition="left">
            <p-inputIcon styleClass="pi pi-search"></p-inputIcon>
            <input 
              pInputText 
              type="text" 
              [(ngModel)]="globalFilter"
              (input)="dt.filterGlobal($any($event.target).value, 'contains')" 
              placeholder="Search companies..." 
              class="p-inputtext-sm w-full md:w-64" />
          </p-iconField>
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="legalName" style="width: 20%">Company Name <p-sortIcon field="legalName"></p-sortIcon></th>
          <th pSortableColumn="ice" style="width: 15%">ICE <p-sortIcon field="ice"></p-sortIcon></th>
          <th style="width: 10%">Legal Form</th>
          <th style="width: 10%">Status</th>
          <th style="width: 10%">Validation</th>
          <th style="width: 15%">Owner</th>
          <th pSortableColumn="lastSync" style="width: 10%">Last Sync <p-sortIcon field="lastSync"></p-sortIcon></th>
          <th style="width: 10%">Role</th>
        </tr>
        <tr>
          <th>
            <p-columnFilter type="text" field="legalName" [showMenu]="false" placeholder="Filter Name"></p-columnFilter>
          </th>
          <th>
            <p-columnFilter type="text" field="ice" [showMenu]="false" placeholder="Filter ICE"></p-columnFilter>
          </th>
          <th></th>
          <th>
            <p-columnFilter field="status" matchMode="equals" [showMenu]="false">
              <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                <p-select 
                  [ngModel]="value" 
                  [options]="statusOptions" 
                  (onChange)="filter($event.value)" 
                  placeholder="Any" 
                  [showClear]="true"
                  appendTo="body">
                  <ng-template let-option pTemplate="item">
                    <p-tag [value]="option.label" [severity]="getSeverity(option.value)"></p-tag>
                  </ng-template>
                </p-select>
              </ng-template>
            </p-columnFilter>
          </th>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-company>
        <tr [pSelectableRow]="company" (click)="onRowClick(company)" class="cursor-pointer hover:bg-gray-50 transition-colors">
          <td>
            <span class="font-medium text-gray-900">{{ company.legalName }}</span>
          </td>
          <td>{{ company.ice }}</td>
          <td>{{ company.legalForm || '-' }}</td>
          <td>
            <p-tag [value]="company.status | uppercase" [severity]="getSeverity(company.status)"></p-tag>
          </td>
          <td>
            <div class="flex items-center gap-2">
              <i class="pi pi-check-circle text-green-500" *ngIf="company.validationStatus === 'validated'"></i>
              <i class="pi pi-clock text-amber-500" *ngIf="company.validationStatus === 'pending'"></i>
              <span class="text-sm">{{ company.validationStatus }}</span>
            </div>
          </td>
          <td>{{ company.ownerName }}</td>
          <td>
            <div class="flex items-center gap-2" [pTooltip]="'Last sync failed'" *ngIf="false"> <!-- Mock warning -->
              <i class="pi pi-exclamation-triangle text-red-500"></i>
            </div>
            {{ company.lastSync | date:'shortDate' }}
          </td>
          <td>
            <p-tag value="Owner" severity="info"></p-tag>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="text-center p-8">
            <div class="flex flex-col items-center justify-center">
              <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                <i class="pi pi-folder-open text-2xl text-gray-400"></i>
              </div>
              <h3 class="text-lg font-medium text-gray-900 mb-1">No companies found</h3>
              <p class="text-gray-500 mb-4">Get started by onboarding your first client.</p>
              <button pButton label="Onboard a new client" icon="pi pi-plus"></button>
            </div>
          </td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="loadingbody">
        <tr *ngFor="let i of [1,2,3,4,5]">
          <td><p-skeleton></p-skeleton></td>
          <td><p-skeleton></p-skeleton></td>
          <td><p-skeleton></p-skeleton></td>
          <td><p-skeleton></p-skeleton></td>
          <td><p-skeleton></p-skeleton></td>
          <td><p-skeleton></p-skeleton></td>
          <td><p-skeleton></p-skeleton></td>
          <td><p-skeleton></p-skeleton></td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>
